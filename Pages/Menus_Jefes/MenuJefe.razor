@page "/MenusJefes/MenuJefe/{NombreUsuario}"
@using Proyect_two.Pages.Menus_clientes
@using Proyect_two.Pages.Clases_Utiles
@inject UsuarioService usuarioService
@inject SolicitudService solicitudService
@inject NavigationManager NavigationManager

<h3>Bienvenido, @NombreCompleto</h3>

@if (Usuario != null)
{
    <div class="perfil-container">
        <div class="perfil-info">
            <p><strong>Nombre:</strong> @Usuario.Nombre</p>
            <p><strong>Apellido:</strong> @Usuario.Apellido</p>
            <p><strong>Email:</strong> @Usuario.Email</p>
        </div>
        <div class="perfil-buttons">
            <button class="btn btn-info" @onclick="CargarSolicitudesEnEspera">Ver Solicitudes en Espera</button>
            <button class="btn btn-primary" @onclick="() => showAddUserModal = true">Agregar Usuario</button>
            <button class="btn btn-secondary" @onclick="() => showSearchModal = true">Buscar Usuarios</button>
        </div>
        @if (SolicitudesEnEspera != null && !SolicitudesEnEspera.ListaVacia())
        {
            <table class="table">
                <thead class="thead-dark">
                    <tr>
                        <th>ID Solicitud</th>
                        <th>Descripción</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (Nodo nodo in SolicitudesEnEspera)
                    {
                        Solicitud solicitud = nodo.Informacion as Solicitud;
                        <tr>
                            <td>@solicitud.IdSolicitud</td>
                            <td>@solicitud.DescripcionProblema</td>
                            <td>@solicitud.Estado</td>
                            <td>
                                <button class="btn btn-success" @onclick="() => MostrarModalAsignarTecnico(solicitud)">Asignar Técnico</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        @if (mostrarModal)
        {
            <TecnicoModal Tecnicos="@Tecnicos" IsOpen="@mostrarModal" OnTecnicoSelected="HandleTecnicoSelected" />
        }
        @if (showAddUserModal)
        {
            <AddUserModal IsOpen="@showAddUserModal" OnClose="() => showAddUserModal = false" />
        }
        @if (showSearchModal)
        {
            <SearchUserModal IsOpen="@showSearchModal" OnClose="() => showSearchModal = false" />
        }
    </div>
}
else
{
    <p>No se pudo cargar la información del usuario.</p>
}

@code {
    private Usuario_classee Usuario;
    private ListaEnlazadaSimple SolicitudesEnEspera, Tecnicos;
    private bool mostrarModal = false;
    private bool showAddUserModal = false;
    private bool showSearchModal = false;
    private Solicitud solicitudSeleccionada;
    [Parameter]
    public string NombreUsuario { get; set; }

    protected override async Task OnInitializedAsync()
    {
        Usuario = await usuarioService.ObtenerUsuarioPorNombreUsuario(NombreUsuario);
        SolicitudesEnEspera = new ListaEnlazadaSimple();
        Tecnicos = await usuarioService.ObtenerTecnicos();
    }

    private async Task CargarSolicitudesEnEspera()
    {
        SolicitudesEnEspera = await solicitudService.ObtenerSolicitudesPorEstado("En espera");
    }

    private void MostrarModalAsignarTecnico(Solicitud solicitud)
    {
        solicitudSeleccionada = solicitud;
        mostrarModal = true;
    }

    private async Task HandleTecnicoSelected(int tecnicoId)
    {
        await solicitudService.AsignarTecnicoASolicitud(solicitudSeleccionada.IdSolicitud, tecnicoId);
        mostrarModal = false;
        await CargarSolicitudesEnEspera(); // Recargar las solicitudes
        solicitudSeleccionada = null; // Resetear la solicitud seleccionada
    }

    private string NombreCompleto => Usuario != null ? $"{Usuario.Nombre} {Usuario.Apellido}" : "Usuario";
}
